# 版本升级

编排完毕，就可以进行升级操作了，系统会按照编排组的顺序，顺序执行：
1. 执行**MQ Topic同步**(默认没有关闭MQ步骤)
2. 执行SQL**脚本**(数据库脚本&QMDB内存库脚本)
3. 执行升级编排组内**应用**，

> **[info] 说明**
> 同一组内，**脚本**的执行是**顺序**执行，**应用**的升级是**并行**升级
> 建议同一编排组内的脚本数量在5~10个(脚本出错后重新执行会将出错所在组的SQL重新解析一遍)

下图就是一键升级的界面

![](/yi-jian-sheng-ji/ban-ben-sheng-ji-1.png)

## 版本升级的功能

* 按照编排的曲线，展示执行结果视图。
* 能够支持升级策略
   * 应用失败跳过继续执行
   * 应用失败终止，支持人工审核，确认执行方式
   * 能够支持单应用的升级
* 应用记录本次升级镜像标识
* 支持应用的回滚，单应用的回滚

> **[success] 说明**
>
> 应用升级时，当一个应用只有**一个容器**时，首先会根据新的镜像拉起一个**新的应用**，然后将原来老的容器terminate掉
>
> 当一个应用有**多个容器**时，会首先根据新的镜像拉起一个新的应用，然后terminate掉一个老应用，然后再根据新的镜像拉起一个新的应用，再terminate掉一个老应用，如此循环，直至所有应用为新版本的容器
>
> 镜像资源会校验镜像的版本是否与CMO提供的一致

## 脚本的升级

升级脚本是通过调用SSC服务中心，接口传入Json模板文件，由SSC做升级操作
* SSC匹配Json，根据租户/项目，将对应的脚本执行在配置的数据库实例用户中。
* 分布式的数据库执行在SSC中控制
* SSC执行过程、结果，通过接口消息返回给一键升级界面，供整体视图展示


## 导出编排
当升级成功后，界面会有一个导出编排的功能，对于此次编排，可以生成一个json文件。

![](/yi-jian-sheng-ji/dao-chu-bian-pai.png)

* 现场获取到所内重新编排的json文件后，可以在现场升级中使用

## 导入编排
这个编排文件需要随CMO发布的版本包一起发给现场，现场在解析版本包时，会在编排界面显示一个按钮【**使用发布包编排**】，点击此按钮，会自动加载发布包中的编排文件，进行自动编排。

![](/yi-jian-sheng-ji/dao-ru-bian-pai-1.png)
